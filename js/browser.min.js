"use strict";var GstBrowser=GstBrowser||{};document.addEventListener("DOMContentLoaded",function(){var a=document.createElement("script");a.src="config.js";a.onload=GstBrowser.init;document.getElementsByTagName("head")[0].appendChild(a)});GstBrowser.init=function(){var c,e,f,a,d,b;c=/[\?&]config=([^&]+)/i.exec(window.location.search);e=(c&&c.length>1?decodeURIComponent(c[1]):"default");c=/[\?&]lang=([^&]+)/i.exec(window.location.search);f=(c&&c.length>1?decodeURIComponent(c[1]):"en");a=(GstBrowser.Config[e]!==undefined?GstBrowser.Config[e]:null);if(a===null){alert("missing config section "+e)}else{a.connector=(a.connector!==undefined?a.connector:null);a.lang=(a.lang!==undefined?a.lang.substr(0,2):f);a.css=(a.css!==undefined?a.css:"css/default.css");a.baseUrl=(a.baseUrl!==undefined?a.baseUrl:window.location.protocol+"//"+window.location.host+"/");a.uploadAccept=(a.uploadAccept!==undefined?a.uploadAccept:"");a.uploadMaxSize=(a.uploadMaxSize!==undefined?a.uploadMaxSize:null);a.callbackSubmit=(typeof a.callbackSubmit==="function"?a.callbackSubmit:null);a.callbackStorno=(typeof a.callbackStorno==="function"?a.callbackStorno:null);a.callbackInit=(typeof a.callbackInit==="function"?a.callbackInit:null);a.configServer=(typeof a.configServer!=="undefined"?a.configServer:null);d=document.createElement("link");d.rel="stylesheet";d.type="text/css";d.href=a.css;document.getElementsByTagName("head")[0].appendChild(d);b=document.createElement("script");b.src="js/lang/"+a.lang+".js";b.onload=function(){GstBrowser.FileBrowser(GstBrowser.Config[e])};document.getElementsByTagName("head")[0].appendChild(b)}};GstBrowser.FileBrowser=function(T){var aj="",M=null,ae="",F=[],z=[],g=document.getElementById("tree"),I=document.getElementById("folder"),A=document.getElementById("fldView"),u=document.getElementById("fldFilter"),O=document.getElementById("selectedFile"),h=document.getElementById("msg"),B=document.getElementById("ajaxIndicator"),af=document.getElementById("butOk"),K=document.getElementById("butStorno"),R=document.getElementById("panelMkdir"),v=document.getElementById("butMkdir"),n=document.getElementById("butSubmitMkdir"),r=document.getElementById("panelDelete"),w=document.getElementById("butDelete"),e=document.getElementById("butSubmitDelete"),c=document.getElementById("panelRename"),j=document.getElementById("butRename"),Y=document.getElementById("butSubmitRename"),ak=document.getElementById("panelCopy"),U=document.getElementById("butCopy"),N=document.getElementById("butSubmitCopy"),f=document.getElementById("panelUpload"),l=document.getElementById("butUpload"),x=f.querySelector("tbody"),b=A.value,P=function(){E("tree","",C)},C=function(al){if(al.status==="OK"){z=al.tree;G();return}a("ErrLoadTree"+al.err)},G=function(){var al=(z[0].children!==undefined),an='<ul><li data-path="" class="collapsed'+(!al?" noSubfolder":"")+'">'+(al?'<span class="expand"> + </span>':"")+'<span class="folder">'+z[0].name+"</span>",am;if(al){for(am=0;am<z[0].children.length;am++){an+=H(z[0].children[am])}}an+="</li></ul>";g.innerHTML=an;g.querySelector("span.folder").classList.add("selected");Array.prototype.forEach.call(g.querySelectorAll("span.folder"),function(ao){ao.addEventListener("mousedown",function(){var ap=ao.parentNode,aq=ap.getAttribute("data-path");while(ap.parentNode){ap=ap.parentNode;if(ap.nodeName!=="LI"&&ap.nodeName!=="UL"){break}if(ap.getAttribute("data-path")!=="undefined"&&ap.getAttribute("data-path")!==null&&ap.getAttribute("data-path")!==""){aq=ap.getAttribute("data-path")+"/"+aq}}s(aq)});ao.addEventListener("drop",function(ar){ar.preventDefault();var ap=ar.dataTransfer.getData("text"),aq=this,at="";if(ap===""){return false}while(aq.parentNode){aq=aq.parentNode;if(aq.nodeName!=="LI"&&aq.nodeName!=="UL"){break}if(aq.getAttribute("data-path")!=="undefined"&&aq.getAttribute("data-path")!==null&&aq.getAttribute("data-path")!==""){at=aq.getAttribute("data-path")+"/"+at}}ak.querySelector('[name="new"]').value=at+ap;ar.dataTransfer.dropEffect=(ar.ctrlKey?"copy":"move");ak.querySelector('[name="action"]').value=ar.dataTransfer.dropEffect;ak.classList.remove("hidden")});ao.addEventListener("dragover",function(ap){ap.preventDefault();ap.dataTransfer.dropEffect=(ap.ctrlKey?"copy":"move");return false})});Array.prototype.forEach.call(g.querySelectorAll("span.expand"),function(ao){ao.addEventListener("mousedown",function(aq){var ap=ao;while(ap.parentNode){ap=ap.parentNode;if(ap.nodeName==="LI"){ap.classList.toggle("collapsed");break}}})});ac()},H=function(an){var al=(an.children!==undefined),ao,am;am='<ul><li data-path="'+an.name+'" class="collapsed'+(!al?" noSubfolder":"")+'">';if(al){am+='<span class="expand"> + </span>'}am+='<span class="folder">'+an.name+"</span>";if(al){am+="<ul>";for(ao=0;ao<an.children.length;ao++){am+=H(an.children[ao])}am+="</ul>"}am+="</li></ul>";return am},ac=function(){E("files","",p)},p=function(al){if(al.status==="OK"){F=al.files;y();return}a("ErrLoadFiles"+al.err)},y=function(){var an=[],al,ao,am;M="";if(ae===""){an=F}else{am=ae.split("|");for(al=0;al<F.length;al++){for(ao=0;ao<am.length;ao++){if(F[al].name.toLowerCase().indexOf(am[ao])!==-1){an.push(F[al]);break}}}}an.sort(function(aq,ap){if(aq.type==="dir"&&ap.type!=="dir"){return -1}if(aq.type!=="dir"&&ap.type==="dir"){return 1}return aq.name<ap.name?-1:1});if(b==="thumbs"){I.innerHTML=o(an)}else{I.innerHTML=i(an)}Array.prototype.forEach.call(I.querySelectorAll("[data-file]"),function(ap){ap.addEventListener("mousedown",function(){ah(this.getAttribute("data-file"))});ap.addEventListener("dblclick",Q);ap.addEventListener("dragstart",function(aq){aq.dataTransfer.setData("text",aq.target.getAttribute("data-file"));return true})})},o=function(an){var am="",al;for(al=0;al<an.length;al++){am+='<div data-file="'+an[al].name+'" data-type="'+an[al].type+'" class="thumb thumb-'+(an[al].type==="dir"?"dir":ag(an[al].name))+'" draggable="'+(an[al].type==="file"?"true":"false")+'"><span class="image">';if(an[al].thumbnail!==null&&an[al].thumbnail!==false&&an[al].thumbnail.indexOf("data:image")!==-1){am+='<img src="'+an[al].thumbnail+'" alt="'+an[al].name+'" ';if(an[al].imgsize!==null){am+=' title="'+an[al].name+", "+an[al].imgsize[0]+"x"+an[al].imgsize[1]+'px"'}am+='draggable="false" />'}am+='</span><span class="name">'+an[al].name+"</span></div>"}return am},i=function(ao){var an='<table><thead><tr><th colspan="2">'+d("Filename")+"</th><th>"+d("Size")+"</th><th>"+d("Dimensions")+"</th><th>"+d("Date")+"</th></tr></thead><tbody>",am,al;for(am=0;am<ao.length;am++){al=new Date(ao[am].date);an+='<tr data-file="'+ao[am].name+'" data-type="'+ao[am].type+'" draggable="'+(ao[am].type==="file"?"true":"false")+'"><td class="icon icon-'+(ao[am].type==="dir"?"dir":ag(ao[am].name))+'"></td><td class="name">'+ao[am].name+"</td><td>";if(ao[am].size!==null){an+=ab(ao[am].size)}an+="</td><td>";if(ao[am].imgsize!==null){an+=ao[am].imgsize[0]+" x "+ao[am].imgsize[0]}an+="</td><td>"+q(al)+"</td></tr>"}an+="</tbody></table>";return an},ag=function(al){return al.split(".").pop().toLowerCase()},s=function(ao){aj=ao;Array.prototype.forEach.call(g.querySelectorAll("span.folder"),function(ap){ap.classList.remove("selected")});g.querySelector("ul li").classList.remove("collapsed");var an=aj.split("/"),al="",am;for(am=0;am<an.length;am++){al+='[data-path="'+an[am]+'"] '}g.querySelector(al).classList.remove("collapsed");if(aj===""){g.querySelector('ul li[data-path=""] span.folder').classList.add("selected")}else{al="";for(am=0;am<an.length;am++){al+='[data-path="'+an[am]+'"] '}g.querySelector(al+" span.folder").classList.add("selected")}Array.prototype.forEach.call(document.querySelectorAll("[data-showpath]"),function(ap){ap.innerHTML=aj});ah("");ac()},ah=function(al){var ao,am;M=null;Array.prototype.forEach.call(I.querySelectorAll("[data-file]"),function(ap){ap.classList.remove("selected")});for(var an=0;an<F.length;an++){if(F[an].name===al){M=F[an];break}}w.disabled=(M===null);j.disabled=(M===null);U.disabled=(M===null||M.type!=="file");af.disabled=(M===null||M.type!=="file");if(M===null){O.innerHTML=""}else{ao='<div class="thumb thumb-'+(M.type==="dir"?"dir":ag(M.name))+'">';if(M.thumbnail!==null&&M.thumbnail.indexOf("data:image")!==-1){ao+='<img src="'+M.thumbnail+'" alt="'+M.name+'" />'}ao+="</div><p>"+M.name+"<br />";if(M.size!==null){ao+=d("Size")+":"+ab(M.size)+"<br />"}if(M.imgsize!==null){ao+=d("Dimensions")+":"+M.imgsize[0]+" x "+M.imgsize[1]+"<br />"}am=new Date(M.date);ao+=d("Date")+":"+am.toLocaleString()+"</p>";O.innerHTML=ao;Array.prototype.forEach.call(document.querySelectorAll("[data-showfile]"),function(ap){ap.innerHTML=M.name});I.querySelector('[data-file="'+M.name+'"]').classList.add("selected")}},W=function(){E("mkdir","dir="+R.querySelector('input[name="newdir"]').value,m)},m=function(al){if(al.status==="OK"){z=al.tree;F=al.files;G();s(aj);R.classList.add("hidden");return}a("ErrMkDir"+al.err)},t=function(){E("delete","name="+M.name,Z)},Z=function(al){if(al.status==="OK"){F=al.files;if(al.tree!==undefined){z=al.tree;G()}else{y();ah("")}r.classList.add("hidden");return}a("ErrDelete"+al.err)},D=function(){E("rename","old="+M.name+"&new="+c.querySelector('input[name="new"]').value,J)},J=function(al){if(al.status==="OK"){F=al.files;if(al.tree!==undefined){z=al.tree;G()}else{y()}c.classList.add("hidden");return}a("ErrRename"+al.err)},ai=function(){E(ak.querySelector('[name="action"]').value,"old="+M.name+"&new="+ak.querySelector('input[name="new"]').value,ad)},ad=function(al){if(al.status==="OK"){if(al.tree!==undefined){z=al.tree;G()}if(al.files!==undefined){F=al.files;y()}ak.classList.add("hidden");return}a("ErrCopy"+al.err)},ab=function(al){var an=["B","kB","MB","GB","TB"],am;if(al<=0){return"0 B"}am=parseInt(Math.floor(Math.log(al)/Math.log(1024)));return Math.round(al/Math.pow(1024,am),2)+" "+an[[am]]},q=function(al){var am=al.toLocaleTimeString();am=am.substr(0,am.length-3);return al.getDate()+"."+(al.getMonth()+1)+"."+al.getFullYear()+" "+am},d=function(al){return(GstBrowser.Translations[al]===undefined?al:GstBrowser.Translations[al])},aa=function(){Array.prototype.forEach.call(document.querySelectorAll(".i18n"),function(al){al.innerHTML=d(al.innerHTML);if(al.title!==""){al.title=d(al.title)}if(typeof al.placeholder!=="undefined"){al.placeholder=d(al.placeholder)}})},a=function(al){h.querySelector("span").innerHTML=d(al);h.classList.remove("hidden")},E=function(ao,an,ar){B.classList.remove("hidden");var aq=(ao==="tree"||ao==="files"?"GET":"POST"),am="config="+T.configServer+"&action="+ao+"&path="+aj+"&"+an,al=T.connector+(aq==="GET"?"?config="+T.configServer+"&action="+ao+"&path="+aj+an+"&r="+Math.random():""),ap=new XMLHttpRequest;ap.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){B.classList.add("hidden");try{var at=JSON.parse(this.responseText)}catch(au){a("ErrLoad");return}ar(at)}else{a("ErrLoad")}}};ap.ontimeout=function(){B.classList.add("hidden");a("ErrLoadTimeout")};ap.open(aq,al,true);ap.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(aq==="GET"){ap.send()}else{ap.send(am)}},Q=function(){if(M.type==="dir"){s(aj+"/"+M.name);return}if(!af.disabled){if(T.callbackSubmit!==null){T.callbackSubmit(T.baseUrl+"/"+aj+(aj!==""?"/":"")+M.name)}}},k=function(an){var am,al,ao;for(am=0;am<an.length;am++){if(T.uploadAccept!==""&&T.uploadAccept.indexOf(an[am].type)===-1){X("",an[am].name,an[am].size,"0%",d("ErrUploadInvalidType"));continue}if(T.uploadMaxSize!==null&&an[am].size>T.uploadMaxSize){X("",an[am].name,an[am].size,"0%",d("ErrUploadInvalidSize"));continue}al=new FormData();al.append("file",an[am]);al.append("config",T.configServer);al.append("action","upload");al.append("path",aj);ao=new XMLHttpRequest();ao.upload.addEventListener("loadstart",S,false);ao.upload.onprogress=function(ar){if(ar.lengthComputable){var aq=Math.round(ar.loaded*100/ar.total),ap=document.getElementById(this.uploadId).querySelector("td.progress");ap.innerHTML=aq.toString()+"%"}};ao.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){L(this)}else{V(this)}}};ao.upload.timeout=60000;ao.upload.ontimeout=function(){V(ao)};ao.upload.uploadId=an[am].name+""+an[am].size;ao.upload.file=an[am];ao.open("POST",T.connector,true);ao.setRequestHeader("X-Requested-With","XMLHttpRequest");ao.setRequestHeader("Cache-Control","no-cache");ao.setRequestHeader("Connection","close");ao.send(al)}},S=function(){X(this.uploadId,this.file.name,this.file.size,"0%","")},X=function(am,ao,an,al,av){var au=x.insertRow(0),at,ar,aq,ap;au.id=am;at=au.insertCell(0);at.innerHTML=ao;ar=au.insertCell(1);ar.innerHTML=ab(an);aq=au.insertCell(2);aq.innerHTML=al;aq.className="progress";ap=au.insertCell(3);ap.className="result";ap.innerHTML=av},L=function(ap){var an,am,al;try{an=JSON.parse(ap.responseText)}catch(ao){V(ap,"ErrUpload");return}if(an.status==="OK"){am=document.getElementById(ap.upload.uploadId).querySelector("td.progress");al=document.getElementById(ap.upload.uploadId).querySelector("td.result");am.innerHTML="100%";al.innerHTML="OK";F=an.files;y();return}V(ap,d("ServerErrorCode"+an.err))},V=function(an,am){var al=document.getElementById(an.upload.uploadId).querySelector("td.result");al.classList.add("error");al.innerHTML=d(typeof am==="undefined"?an.statusText:am)};af.addEventListener("mousedown",Q);K.addEventListener("mousedown",function(){if(T.callbackStorno!==null){T.callbackStorno()}});A.addEventListener("change",function(){b=A.value;y()});u.addEventListener("keyup",function(){this.value=this.value.toLowerCase();ae=this.value;y()});Array.prototype.forEach.call(document.querySelectorAll("button[data-action-closepanel]"),function(al){al.addEventListener("mousedown",function(){document.getElementById(this.getAttribute("data-action-closepanel")).classList.add("hidden")})});v.addEventListener("mousedown",function(){R.querySelector('input[type="text"]').value="";R.classList.remove("hidden");setTimeout(function(){R.querySelector('input[type="text"]').focus()},0)});n.addEventListener("mousedown",W);w.addEventListener("mousedown",function(){r.classList.remove("hidden")});e.addEventListener("mousedown",t);j.addEventListener("mousedown",function(){if(M===""){return}c.querySelector('input[type="text"]').value="";c.classList.remove("hidden");setTimeout(function(){c.querySelector('input[type="text"]').focus()},0)});Y.addEventListener("mousedown",D);U.addEventListener("mousedown",function(){if(M===""){return}ak.classList.remove("hidden");setTimeout(function(){ak.querySelector('input[type="text"]').focus()},0)});N.addEventListener("mousedown",ai);l.addEventListener("mousedown",function(){x.innerHTML="";var al=document.createElement("input"),am;al.type="file";al.accept=T.uploadAccept;al.multiple=true;al.id="fldUpload";am=f.querySelector('[type="file"]');am.parentNode.replaceChild(al,am);al.addEventListener("change",function(){if(this.files.length){k(this.files)}});f.classList.remove("hidden")});h.querySelector("button").addEventListener("mousedown",function(){h.querySelector("span").innerHTML==="";h.classList.add("hidden")});I.ondragover=function(al){al.preventDefault();return false};I.addEventListener("drop",function(al){al.preventDefault();if(al.dataTransfer.files.length>0){f.classList.remove("hidden");k(al.dataTransfer.files)}});if(T.callbackInit!==null){T.callbackInit()}aa();ah("");P()};
"use strict";var GstBrowser=GstBrowser||{};document.addEventListener("DOMContentLoaded",function(){var a=document.createElement("script");a.src="config.js";a.onload=GstBrowser.init;document.getElementsByTagName("head")[0].appendChild(a)});GstBrowser.init=function(){var c=/[\?&]config=([^&]+)/i.exec(window.location.search);var e=(c&&c.length>1?decodeURIComponent(c[1]):"default");c=/[\?&]lang=([^&]+)/i.exec(window.location.search);var f=(c&&c.length>1?decodeURIComponent(c[1]):"en");var a=(GstBrowser.Config[e]!==undefined?GstBrowser.Config[e]:null);if(a===null){alert("missing config section "+e)}else{a.connector=(a.connector!==undefined?a.connector:null);a.lang=(a.lang!==undefined?a.lang.substr(0,2):f);a.css=(a.css!==undefined?a.css:"css/default.css");a.baseUrl=(a.baseUrl!==undefined?a.baseUrl:window.location.protocol+"//"+window.location.host+"/");a.uploadAccept=(a.uploadAccept!==undefined?a.uploadAccept:"");a.uploadMaxSize=(a.uploadMaxSize!==undefined?a.uploadMaxSize:null);a.callbackSubmit=(typeof a.callbackSubmit==="function"?a.callbackSubmit:null);a.callbackStorno=(typeof a.callbackStorno==="function"?a.callbackStorno:null);a.callbackInit=(typeof a.callbackInit==="function"?a.callbackInit:null);a.configServer=(typeof a.configServer!=="undefined"?a.configServer:null);var d=document.createElement("link");d.rel="stylesheet";d.type="text/css";d.href=a.css;document.getElementsByTagName("head")[0].appendChild(d);var b=document.createElement("script");b.src="js/lang/"+a.lang+".js";b.onload=function(){GstBrowser.FileBrowser(GstBrowser.Config[e])};document.getElementsByTagName("head")[0].appendChild(b)}};GstBrowser.FileBrowser=function(S){var ai="";var L=null;var ad="";var E=[];var z=[];var g=document.getElementById("tree"),H=document.getElementById("folder"),A=document.getElementById("fldView"),u=document.getElementById("fldFilter"),N=document.getElementById("selectedFile"),h=document.getElementById("msg"),j=document.getElementById("butRename"),T=document.getElementById("butCopy"),ae=document.getElementById("butOk"),J=document.getElementById("butStorno"),Q=document.getElementById("panelMkdir"),v=document.getElementById("butMkdir"),n=document.getElementById("butSubmitMkdir"),r=document.getElementById("panelDelete"),w=document.getElementById("butDelete"),e=document.getElementById("butSubmitDelete"),c=document.getElementById("panelRename"),j=document.getElementById("butRename"),X=document.getElementById("butSubmitRename"),aj=document.getElementById("panelCopy"),T=document.getElementById("butCopy"),M=document.getElementById("butSubmitCopy"),f=document.getElementById("panelUpload"),l=document.getElementById("butUpload"),x=f.querySelector("tbody");var b=A.value;var O=function(){D("tree","",B)};var B=function(ak){if(ak.status==="OK"){z=ak.tree;F();return}a("ErrLoadTree"+ak.msg)};var F=function(){var ak=(z[0].children!==undefined);var am='<ul><li data-path="" class="collapsed'+(!ak?"noSubfolder":"")+'">'+(ak?'<span class="expand"> + </span>':"")+'<span class="folder">'+z[0].name+"</span>";if(ak){for(var al=0;al<z[0].children.length;al++){am+=G(z[0].children[al])}}am+="</li></ul>";g.innerHTML=am;g.querySelector("span.folder").classList.add("selected");Array.prototype.forEach.call(g.querySelectorAll("span.folder"),function(an){an.addEventListener("mousedown",function(ap){Array.prototype.forEach.call(g.querySelectorAll("span.folder"),function(ar){ar.classList.remove("selected")});an.classList.add("selected");var ao=an.parentNode;var aq=ao.getAttribute("data-path");while(ao.parentNode){ao=ao.parentNode;if(ao.nodeName!=="LI"&&ao.nodeName!=="UL"){break}if(ao.getAttribute("data-path")!=="undefined"&&ao.getAttribute("data-path")!==null&&ao.getAttribute("data-path")!==""){aq=ao.getAttribute("data-path")+"/"+aq}}s(aq)});an.addEventListener("drop",function(aq){aq.preventDefault();var ao=aq.dataTransfer.getData("text");if(ao===""){return false}var ap=this;var ar="";while(ap.parentNode){ap=ap.parentNode;if(ap.nodeName!=="LI"&&ap.nodeName!=="UL"){break}if(ap.getAttribute("data-path")!=="undefined"&&ap.getAttribute("data-path")!==null&&ap.getAttribute("data-path")!==""){ar=ap.getAttribute("data-path")+"/"+ar}}aj.querySelector('[name="new"]').value=ar+ao;aq.dataTransfer.dropEffect=(aq.ctrlKey?"copy":"move");aj.querySelector('[name="action"]').value=aq.dataTransfer.dropEffect;aj.classList.remove("hidden")});an.addEventListener("dragover",function(ao){ao.preventDefault();ao.dataTransfer.dropEffect=(ao.ctrlKey?"copy":"move");return false})});Array.prototype.forEach.call(g.querySelectorAll("span.expand"),function(an){an.addEventListener("mousedown",function(ap){var ao=an;while(ao.parentNode){ao=ao.parentNode;if(ao.nodeName==="LI"){ao.classList.toggle("collapsed");break}}})});ab()};var G=function(am){var ak=(am.children!==undefined),an,al;al='<ul><li data-path="'+am.name+'" class="collapsed'+(!ak?" noSubfolder":"")+'">';if(ak){al+='<span class="expand"> + </span>'}al+='<span class="folder">'+am.name+"</span>";if(ak){al+="<ul>";for(an=0;an<am.children.length;an++){al+=G(am.children[an])}al+="</ul>"}al+="</li></ul>";return al};var ab=function(){D("files","",p)};var p=function(ak){if(ak.status==="OK"){E=ak.files;y();return}a("ErrLoadFiles"+ak.msg)};var y=function(){var am=[],ak,an,al;L="";if(ad===""){am=E}else{al=ad.split("|");for(ak=0;ak<E.length;ak++){for(an=0;an<al.length;an++){if(E[ak].name.toLowerCase().indexOf(al[an])!==-1){am.push(E[ak]);break}}}}am.sort(function(ap,ao){if(ap.type==="dir"&&ao.type!=="dir"){return -1}if(ap.type!=="dir"&&ao.type==="dir"){return 1}return ap.name<ao.name?-1:1});if(b==="thumbs"){H.innerHTML=o(am)}else{H.innerHTML=i(am)}Array.prototype.forEach.call(H.querySelectorAll("[data-file]"),function(ao){ao.addEventListener("mousedown",function(){ag(this.getAttribute("data-file"))});ao.addEventListener("dblclick",P);ao.addEventListener("dragstart",function(ap){ap.dataTransfer.setData("text",ap.target.getAttribute("data-file"));return true})})};var o=function(am){var al="";for(var ak=0;ak<am.length;ak++){al+='<div data-file="'+am[ak].name+'" data-type="'+am[ak].type+'" class="thumb thumb-'+(am[ak].type==="dir"?"dir":af(am[ak].name))+'" draggable="'+(am[ak].type==="file"?"true":"false")+'"><span class="image">';if(am[ak].thumbnail!==null&&am[ak].thumbnail!==false&&am[ak].thumbnail.indexOf("data:image")!==-1){al+='<img src="'+am[ak].thumbnail+'" alt="'+am[ak].name+'" ';if(am[ak].imgsize!==null){al+=' title="'+am[ak].name+", "+am[ak].imgsize[0]+"x"+am[ak].imgsize[1]+'px"'}al+='draggable="false" />'}al+='</span><span class="name">'+am[ak].name+"</span></div>"}return al};var i=function(an){var am='<table><thead><tr><th colspan="2">'+d("Filename")+"</th><th>"+d("Size")+"</th><th>"+d("Dimensions")+"</th><th>"+d("Date")+"</th></tr></thead><tbody>";for(var al=0;al<an.length;al++){var ak=new Date(an[al].date);am+='<tr data-file="'+an[al].name+'" data-type="'+an[al].type+'" draggable="'+(an[al].type==="file"?"true":"false")+'"><td class="icon icon-'+(an[al].type==="dir"?"dir":af(an[al].name))+'"></td><td class="name">'+an[al].name+"</td><td>";if(an[al].size!==null){am+=aa(an[al].size)}am+="</td><td>";if(an[al].imgsize!==null){am+=an[al].imgsize[0]+" x "+an[al].imgsize[0]}am+="</td><td>"+q(ak)+"</td></tr>"}am+="</tbody></table>";return am};var af=function(ak){return ak.split(".").pop().toLowerCase()};var s=function(ak){ai=ak;Array.prototype.forEach.call(document.querySelectorAll("[data-showpath]"),function(al){al.innerHTML=ai});ag("");ab()};var ag=function(ak){L=null;Array.prototype.forEach.call(H.querySelectorAll("[data-file]"),function(ao){ao.classList.remove("selected")});for(var an=0;an<E.length;an++){if(E[an].name===ak){L=E[an];break}}w.disabled=(L===null);j.disabled=(L===null);T.disabled=(L===null||L.type!=="file");ae.disabled=(L===null||L.type!=="file");if(L===null){N.innerHTML=""}else{var am='<div class="thumb thumb-'+(L.type==="dir"?"dir":af(L.name))+'">';if(L.thumbnail!==null&&L.thumbnail.indexOf("data:image")!==-1){am+='<img src="'+L.thumbnail+'" alt="'+L.name+'" />'}am+="</div><p>"+L.name+"<br />";if(L.size!==null){am+=d("Size")+":"+aa(L.size)+"<br />"}if(L.imgsize!==null){am+=d("Dimensions")+":"+L.imgsize[0]+" x "+L.imgsize[1]+"<br />"}var al=new Date(L.date);am+=d("Date")+":"+al.toLocaleString()+"</p>";N.innerHTML=am;Array.prototype.forEach.call(document.querySelectorAll("[data-showfile]"),function(ao){ao.innerHTML=L.name});H.querySelector('[data-file="'+L.name+'"]').classList.add("selected")}};var V=function(){D("mkdir","dir="+Q.querySelector('input[name="newdir"]').value,m)};var m=function(ak){if(ak.status==="OK"){z=ak.tree;E=ak.files;F();Q.classList.add("hidden");return}a("ErrMkDir"+ak.msg)};var t=function(){D("delete","name="+L.name,Y)};var Y=function(ak){if(ak.status==="OK"){E=ak.files;if(ak.tree!==undefined){z=ak.tree;F()}else{y();ag("")}r.classList.add("hidden");return}a("ErrDelete"+ak.msg)};var C=function(){D("rename","old="+L.name+"&new="+c.querySelector('input[name="new"]').value,I)};var I=function(ak){if(ak.status==="OK"){E=ak.files;if(ak.tree!==undefined){z=ak.tree;F()}else{y()}c.classList.add("hidden")}a("ErrRename"+ak.msg)};var ah=function(){D(aj.querySelector('[name="action"]').value,"old="+L.name+"&new="+aj.querySelector('input[name="new"]').value,ac)};var ac=function(ak){if(ak.status==="OK"){if(ak.tree!==undefined){z=ak.tree;F()}if(ak.files!==undefined){E=ak.files;y()}aj.classList.add("hidden")}a("ErrCopy"+ak.msg)};var aa=function(ak){var am=["B","kB","MB","GB","TB"],al;if(ak<=0){return"0 B"}var al=parseInt(Math.floor(Math.log(ak)/Math.log(1024)));return Math.round(ak/Math.pow(1024,al),2)+" "+am[[al]]};var q=function(ak){var al=ak.toLocaleTimeString();al=al.substr(0,al.length-3);return ak.getDate()+"."+(ak.getMonth()+1)+"."+ak.getFullYear()+" "+al};var d=function(ak){return(GstBrowser.Translations[ak]===undefined?ak:GstBrowser.Translations[ak])};var Z=function(){Array.prototype.forEach.call(document.querySelectorAll(".i18n"),function(ak){ak.innerHTML=d(ak.innerHTML);if(ak.title!==""){ak.title=d(ak.title)}if(typeof ak.placeholder!=="undefined"){ak.placeholder=d(ak.placeholder)}})};var a=function(ak){h.querySelector("span").innerHTML=d(ak);h.classList.remove("hidden")};var D=function(an,am,aq){var ap=(an==="tree"||an==="files"?"GET":"POST");var al="config="+S.configServer+"&action="+an+"&path="+ai+"&"+am;var ak=S.connector+(ap==="GET"?"?config="+S.configServer+"&action="+an+"&path="+ai+am+"&r="+Math.random():"");var ao=new XMLHttpRequest;ao.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){try{var ar=JSON.parse(this.responseText)}catch(at){a("ErrLoad");return}aq(ar)}else{a("ErrLoad")}}};ao.ontimeout=function(){a("ErrLoadTimeout")};ao.open(ap,ak,true);ao.setRequestHeader("Content-type","application/x-www-form-urlencoded");if(ap==="GET"){ao.send()}else{ao.send(al)}};var P=function(){if(!ae.disabled){if(S.callbackSubmit!==null){S.callbackSubmit(S.baseUrl+"/"+ai+(ai!==""?"/":"")+L.name)}}};ae.addEventListener("mousedown",P);J.addEventListener("mousedown",function(){if(S.callbackStorno!==null){S.callbackStorno()}});A.addEventListener("change",function(){b=A.value;y()});u.addEventListener("keyup",function(){this.value=this.value.toLowerCase();ad=this.value;y()});Array.prototype.forEach.call(document.querySelectorAll("button[data-action-closepanel]"),function(ak){ak.addEventListener("mousedown",function(){document.getElementById(this.getAttribute("data-action-closepanel")).classList.add("hidden")})});v.addEventListener("mousedown",function(){Q.querySelector('input[type="text"]').value="";Q.classList.remove("hidden")});n.addEventListener("mousedown",V);w.addEventListener("mousedown",function(){r.classList.remove("hidden")});e.addEventListener("mousedown",t);j.addEventListener("mousedown",function(){if(L===""){return}c.classList.remove("hidden")});X.addEventListener("mousedown",C);T.addEventListener("mousedown",function(){if(L===""){return}aj.classList.remove("hidden")});M.addEventListener("mousedown",ah);l.addEventListener("mousedown",function(){x.innerHTML="";var ak=document.createElement("input");ak.type="file";ak.accept=S.uploadAccept;ak.multiple=true;ak.id="fldUpload";var al=f.querySelector('[type="file"]');al.parentNode.replaceChild(ak,al);ak.addEventListener("change",function(){if(this.files.length){k(this.files)}});f.classList.remove("hidden")});h.querySelector("button").addEventListener("mousedown",function(){h.querySelector("span").innerHTML==="";h.classList.add("hidden")});var k=function(am){for(var al=0;al<am.length;al++){if(S.uploadAccept!==""&&S.uploadAccept.indexOf(am[al].type)===-1){W("",am[al].name,am[al].size,"0%",d("ErrUploadInvalidType"));continue}if(S.uploadMaxSize!==null&&am[al].size>S.uploadMaxSize){W("",am[al].name,am[al].size,"0%",d("ErrUploadInvalidSize"));continue}var ak=new FormData();ak.append("file",am[al]);ak.append("config",S.configServer);ak.append("action","upload");ak.append("path",ai);var an=new XMLHttpRequest();an.upload.addEventListener("loadstart",R,false);an.upload.onprogress=function(aq){if(aq.lengthComputable){var ap=Math.round(aq.loaded*100/aq.total);var ao=document.getElementById(this.uploadId).querySelector("td.progress");ao.innerHTML=ap.toString()+"%"}};an.onreadystatechange=function(){if(this.readyState===4){if(this.status===200){K(this)}else{U(this)}}};an.upload.timeout=60000;an.upload.ontimeout=function(){U(an)};an.upload.uploadId=am[al].name+""+am[al].size;an.upload.file=am[al];an.open("POST",S.connector,true);an.setRequestHeader("X-Requested-With","XMLHttpRequest");an.setRequestHeader("Cache-Control","no-cache");an.setRequestHeader("Connection","close");an.send(ak)}};var R=function(){W(this.uploadId,this.file.name,this.file.size,"0%","")};var W=function(al,an,am,ak,au){var at=x.insertRow(0);at.id=al;var ar=at.insertCell(0);ar.innerHTML=an;var aq=at.insertCell(1);aq.innerHTML=aa(am);var ap=at.insertCell(2);ap.innerHTML=ak;ap.className="progress";var ao=at.insertCell(3);ao.className="result";ao.innerHTML=au};var K=function(ao){try{var am=JSON.parse(ao.responseText)}catch(an){U(ao,"ErrUpload");return}if(am.status==="OK"){var al=document.getElementById(ao.upload.uploadId).querySelector("td.progress");al.innerHTML="100%";var ak=document.getElementById(ao.upload.uploadId).querySelector("td.result");ak.innerHTML="OK";E=am.files;y();return}U(ao,d("ServerErrorCode"+am.err))};var U=function(am,al){var ak=document.getElementById(am.upload.uploadId).querySelector("td.result");ak.classList.add("error");ak.innerHTML=d(typeof al==="undefined"?am.statusText:al)};H.ondragover=function(ak){ak.preventDefault();return false};H.addEventListener("drop",function(ak){ak.preventDefault();if(ak.dataTransfer.files.lenth>0){f.classList.remove("hidden");k(ak.dataTransfer.files)}});if(S.callbackInit!==null){S.callbackInit()}Z();ag("");O()};